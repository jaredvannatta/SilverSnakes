pico-8 cartridge // http://www.pico-8.com
version 35
__lua__
--game loop

function _init()
	t=0
--	p_anim={1,2,3,4}	
 map_setup()
 text_setup()
 make_player()
 p_anim_time=0
 p_anim_wait=.5
 game_win=false
 game_over=false
end

function _update()
	t+=1
	
	if time() - p_anim_time > p_anim_wait then
		p.sprite+=1
		p_anim_time=time()
	if p.sprite > 5 then
		p.sprite=1
	end
	end
	
	
	if (not game_over) then
	 if (not active_text) then
		 update_map()
		 move_player()
		 check_win_lose()
		end 
	else
		if (btnp(‚ùé)) extcmd("reset")
	end
end

function _draw()
 cls()
 if (not game_over) then
	 draw_map()
  draw_player()
  draw_text()
 	if (btn(‚ùé)) show_inventory()
 else
 	draw_win_lose()
 end
end

--function startgame()
--	p_x=3
--	p_y=5
--end

-->8
 --map code

function map_setup()
	--timers
	timer = 0
	anim_time = 30 --30 = 1 second
 
 --map tile settings
 wall=0
 key=1
 door=2
 anim1=3
 anim2=4
 text=5
 lose=6
 win=7
end

function update_map()
	if (timer<0) then 
		toggle_tiles()
		timer=anim_time
	end
		timer-=1
end

function draw_map()
	mapx=flr(p.x/16)*16
	mapy=flr(p.y/16)*16
	camera(mapx*8,mapy*8)

 map()
end

function is_tile(tile_type,x,y)
 tile=mget(x,y)
 has_flag=fget(tile,tile_type)
 return has_flag
end

function can_move(x,y)
 return not is_tile(wall,x,y)
end

function swap_tile(x,y)
	tile=mget(x,y)
	mset(x,y,tile+1)
end

function unswap_tile(x,y)
	tile=mget(x,y)
	mset(x,y,tile-1)
end

function get_key(x,y)
	p.keys+=1
	swap_tile(x,y)
	sfx(1)
end

function open_door(x,y)
	p.keys -=1
	swap_tile(x,y)
	sfx(2)
end
-->8
--player code

function make_player()
 p={}
 p.x=3
 p.y=2
-- p_ox=0
--	p_oy=0
 p.sprite=1
 p.keys = 0
end

function draw_player()
 spr(p.sprite,p.x*8,p.y*8)
end

function move_player()
 newx=p.x
 newy=p.y
-- _upd = update_pwalk
 
 if (btnp(‚¨ÖÔ∏è)) then
  newx -= 1
 -- p_0x=8
 end
 if (btnp(‚û°Ô∏è)) then
  newx += 1
 -- p_ox =-8
 end
 if (btnp(‚¨ÜÔ∏è)) then
  newy -= 1
 -- p_oy = 8
 end
 if (btnp(‚¨áÔ∏è)) then
  newy += 1
 -- p_oy =-8
 	
 end
 interact(newx,newy)
 
 if (can_move(newx,newy)) then
  p.x=mid(0,newx,127)
  p.y=mid(0,newy,63)
 else
  sfx(0)
 end
end

-- function update_pwalk()
	--	if p_0x>0 then
	--	p_0x-=1
	--	end
	--	if p_0x == 0 and p_0y == 0 then
		-- _upd = moveplayer
	--	end
-- end

function interact(x,y)
 if (is_tile(text,x,y)) then
  active_text=get_text(x,y)
 end
	if (is_tile(key,x,y)) then
		get_key(x,y)
		elseif (is_tile(door,x,y) and p.keys >0) then
		open_door(x,y)
	end
end
-->8
--inventory code

function show_inventory()
	invx = mapx*8+40
	invy = mapy*8+8
	
	rectfill(invx,invy,invx+48,invy+24,0)
	print("inventory", invx +7, invy+4,7)
	print("keys " ..p.keys,invx+12,invy+14,9)
end
-->8
--animation code

function toggle_tiles()
	for x=mapx,mapx+15 do
		for y=mapy,mapy+15 do
			if (is_tile(anim1,x,y)) then
				swap_tile(x,y)
				sfx(3)
			elseif (is_tile(anim2,x,y)) then
				unswap_tile(x,y)
				sfx(3)
			end
		end
	end
end	
-->8
--win/lose conditions
function check_win_lose()
	if (is_tile(win,p.x,p.y)) then
		game_win=true
		game_over=true
	elseif (is_tile(lose,p.x,p.y)) then
		game_win=false
		game_over=true
	end
end

function draw_win_lose()
	camera()
	if (game_win) then
		print("‚ô™‚ô™ you win! ‚ô•‚ô•", 37,64,7)
	else
		print("game over üòêüòê",38,64,7)
	end
	print("press ‚ùé to play again", 20, 72, 5)
end

-->8
--tools

function get_frame(anim)
		return p_anim[flr(t/8)%4+1]
end


-->8
--game text

function text_setup()
 texts={}
 add_text(10,12,"this is just a castle \nno keys in here")
 add_text(30,07,"just ignore those spikes \nthey're harmless \n..... i promise")
end
 
function add_text(x,y,message)
 texts[x+y*128]=message
end

function get_text(x,y)
 return texts[x+y*128]
end

function draw_text()
 if (active_text) then
  textx=mapx*8+4
  texty=mapy*8+48
  rectfill(textx,texty,textx+119,texty+31,7)
  print(active_text,textx+4,texty+4,1)
  print("üÖæÔ∏è to close",textx+4,texty+23,6)
 end
 if (btnp(üÖæÔ∏è)) active_text=nil
end
__gfx__
000000000605550060055500000555000005550000055500000000000000000000000000666666665a0a0a500555500000000000000000000000000000000000
000000000605f5000605f5000005f5000005f5000005f500000000000000000000000000668888660aaaaa0505ff500000000000000000000000000000000000
007007000633333055533330053333300433333004333330000000000000000000000000686666865afafa500111100000000000000000000000000000000000
000770005553330004033300654333005553330055533300000000000000000000000000686886860afffa05f0110f0000000000000000000000000000000000
00077000040545000005450005054500060545000605450000000000000000000000000068688686502220500055000000000000000000000000000000000000
007007000004440000044400000444006004440006044400000000000000000000000000686666860f222f050500500000000000000000000000000000000000
0000000000040400000404000004040000040400060404000000000000000000000000006688886650d0d0500500500000000000000000000000000000000000
00000000000404000000040000040000000004000000040000000000000000000000000066666666050505050000000000000000000000000000000000000000
00000600033300000003000000200000006600000000500000000000000050004444444400000000000000000000000000000000000000000000000000000000
00000000333003000033300000220000066666000000000099900000000000004ffffff106000600050005000000000000000000000000000000000000000000
0006000003303330003330002020020066660600000000009a999999000000004f1ff1f156505650565056500000000000000000000000000000000000000000
600000000000333003333300020220006606666005000000909aa9a9050000004f1f1ff105000500050005000000000000000000000000000000000000000000
00000060033033000333330000220200606660600000050099900a0a000005004ffffff100000000000000000000000000000000000000000000000000000000
000000003330000033030330000200006666066005000000aaa00000050000004111111106000600050005000000000000000000000000000000000000000000
06000000330000000003000000020000066660000000000000000000000000000004100056505650565056500000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000004100005000500050005000000000000000000000000000000000000000000
c000ccc000000000dd000d000000000000000000000000004a4444a44a4aa4a40000000000000000000000000000000000000000000000000000000000000000
0ccc00001001000000ddd0000000000000000000000000004a4444a4050990500000000000000000000000000000000000000000000000000000000000000000
0000000001100000000000000000000000000000000000004a4444a4000000000000000000000000000000000000000000000000000000000000000000000000
ccc00cc000001010000000000000000000000000000000004a4444a4000000000000000000000000000000000000000000000000000000000000000000000000
000cc00010000100d0000dd0000000000000000000000000aaa99aaa050000500000000000000000000000000000000000000000000000000000000000000000
cc0000c0011000000dddd000000000000000000000000000090990904a4444a40000000000000000000000000000000000000000000000000000000000000000
00cccc0000001100000000000000000000000000000000004a4444a44a4444a40000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000004a4444a44a4444a40000000000000000000000000000000000000000000000000000000000000000
00000000050505050707070066606660665a56600000000000444400550000550000000000000000000000000000000000000000000000000000000000000000
00000000505050507000007000000000009896600000000004444440500000050000000000000000000000000000000000000000000000000000000000000000
00606000050505050070700060666060669990000000000005544440500000050000000000000000000000000000000000000000000000000000000000000000
00060000505050507000007000000000064446600000000004444440500000050000000000000000000000000000000000000000000000000000000000000000
00606000050505050070700066606660664440600000000004444740500000050000000000000000000000000000000000000000000000000000000000000000
00000000505050507000007000000000604446600000000004444440500000050000000000000000000000000000000000000000000000000000000000000000
00000000050505050707070060666060665456000000000005544440500000050000000000000000000000000000000000000000000000000000000000000000
00000000505050500000000000000000066666600000000004444440500000050000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000001008001010000000000000101010002002148100000000000010101000000020100000000000000000000000101000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
33333131310a3131313333171717171717171717171717171717171717171712120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333313131323131313333171717171717171726171717171717171717171712120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333313133313331313333171717171117171717171717171717171717171712120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333313133313331313333171717171717171717171717111717171717171712120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333433323334333333171717171717171717171717171717171717171712120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333313131313131313333171711171717171711171717171712171717171712120000000000001300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333313131323131313333171717171712171717171717171717171717171712120000000000001300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333433313334333333171717121717171717171217171717171717171834331313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333313131313131313333171717171717141717171717171717171017171036101900000000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333313131323131313333171717171717171717171717171717101010101034331313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333317101733333333171717171217171217171717171710101717170b12120000000000001300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333417101734333333171717171717171717171710101010171712171712121200000000001300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
171717170b100b17171718171712171717171717101010171717171717171712121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1717171717101717171717171717171717171010101717171717141717171712121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1712171717101010101010101010101010101017171712171717171717171712120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1717171717171717171717171717171717171717171717171717171717171712120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1212121212121212121212121212121212121212121212121212121212121212120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1212121212121212121212121212121212121212121212121212121212121212120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000400000d030080301670025700000000000000000000000000000000000000000000000000000c000310002e000000000000000000000000000000000000000000000000000000000000000000000000000000
000600002507038000330703307033070330603305033050330303301000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000c00001705019050220502d0502a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000300000c62010620006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
00 01424344

